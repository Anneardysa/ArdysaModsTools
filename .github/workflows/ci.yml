# GitHub Actions Workflow: Build and Test
# Runs on every push to main and all pull requests
# Includes test coverage reporting

name: Build and Test

on:
   push:
      branches: [main]
   pull_request:
      branches: [main]

env:
   DOTNET_VERSION: "8.0.x"
   PROJECT_FILE: ArdysaModsTools.csproj
   TEST_PROJECT: Tests/ArdysaModsTools.Tests.csproj

jobs:
   build-and-test:
      runs-on: windows-latest

      steps:
         - name: Checkout code
           uses: actions/checkout@v4

         - name: Setup .NET
           uses: actions/setup-dotnet@v4
           with:
              dotnet-version: ${{ env.DOTNET_VERSION }}

         - name: Restore dependencies
           run: dotnet restore ${{ env.PROJECT_FILE }}

         - name: Build
           run: dotnet build ${{ env.PROJECT_FILE }} -c Release --no-restore

         - name: Restore test dependencies
           run: dotnet restore ${{ env.TEST_PROJECT }}

         - name: Run tests with coverage
           run: |
              dotnet test ${{ env.TEST_PROJECT }} `
                --configuration Release `
                --no-restore `
                --collect:"XPlat Code Coverage" `
                --results-directory ./coverage `
                -- DataCollectionRunSettings.DataCollectors.DataCollector.Configuration.Format=cobertura

         - name: Upload coverage report
           uses: actions/upload-artifact@v4
           with:
              name: coverage-report
              path: coverage/**/coverage.cobertura.xml
              retention-days: 7

         - name: Code Coverage Summary
           uses: irongut/CodeCoverageSummary@v1.3.0
           with:
              filename: coverage/**/coverage.cobertura.xml
              badge: true
              format: markdown
              output: both
              thresholds: "60 70"

         - name: Add Coverage PR Comment
           uses: marocchino/sticky-pull-request-comment@v2
           if: github.event_name == 'pull_request'
           with:
              recreate: true
              path: code-coverage-results.md
