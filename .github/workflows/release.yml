# GitHub Actions Workflow: Build and Release
# Triggers when you push a version tag like v2.0.0
# Creates a GitHub release with installer build

name: Build and Release

on:
   push:
      tags:
         - "v*.*.*" # Triggers on tags like v2.0.0, v2.1.0-beta, etc.
   workflow_dispatch: # Allows manual trigger from GitHub UI
      inputs:
         version:
            description: "Version to release (e.g., 2.0.0)"
            required: true
            type: string

env:
   DOTNET_VERSION: "8.0.x"
   PROJECT_NAME: ArdysaModsTools
   PROJECT_FILE: ArdysaModsTools.csproj

# Required permissions for creating releases
permissions:
   contents: write

jobs:
   build:
      runs-on: windows-latest

      steps:
         - name: Checkout code
           uses: actions/checkout@v4

         - name: Setup .NET
           uses: actions/setup-dotnet@v4
           with:
              dotnet-version: ${{ env.DOTNET_VERSION }}

         - name: Get version from tag
           id: version
           shell: pwsh
           run: |
              if ("${{ github.event_name }}" -eq "workflow_dispatch") {
                $version = "${{ github.event.inputs.version }}"
              } else {
                $version = "${{ github.ref_name }}".TrimStart('v')
              }
              echo "VERSION=$version" >> $env:GITHUB_OUTPUT
              echo "Building version: $version"

         - name: Restore dependencies
           run: dotnet restore ${{ env.PROJECT_FILE }}

         # Build for Installer (self-contained, multi-file)
         - name: Build Installer Package
           run: |
              dotnet publish ${{ env.PROJECT_FILE }} `
                -c Release `
                -r win-x64 `
                --self-contained true `
                -p:PublishSingleFile=false `
                -o publish/installer

         # Install Inno Setup
         - name: Install Inno Setup
           shell: pwsh
           run: |
              choco install innosetup -y
              echo "C:\Program Files (x86)\Inno Setup 6" >> $env:GITHUB_PATH

         - name: Build Installer EXE
           shell: pwsh
           run: |
              # Update version in ISS file
              $issContent = Get-Content "Build\Installer\${{ env.PROJECT_NAME }}.iss" -Raw
              $displayVersion = "${{ steps.version.outputs.VERSION }}"

              # Create numeric version (strip -beta, -alpha, etc. and ensure 4 parts)
              $numericVersion = $displayVersion -replace '-.*$', ''
              $parts = $numericVersion.Split('.')
              while ($parts.Count -lt 4) { $parts += '0' }
              $numericVersion = ($parts[0..3]) -join '.'

              # Replace both versions
              $issContent = $issContent -replace '#define MyAppVersion ".*"', "#define MyAppVersion `"$displayVersion`""
              $issContent = $issContent -replace '#define MyAppVersionNumeric ".*"', "#define MyAppVersionNumeric `"$numericVersion`""
              Set-Content "Build\Installer\${{ env.PROJECT_NAME }}.iss" $issContent

              # Compile installer
              iscc "Build\Installer\${{ env.PROJECT_NAME }}.iss"

         - name: Prepare Artifacts
           shell: pwsh
           run: |
              $version = "${{ steps.version.outputs.VERSION }}"

              # Create output directory
              New-Item -ItemType Directory -Path "release" -Force

              # Copy installer
              Copy-Item "Build\Installer\Output\*.exe" "release\${{ env.PROJECT_NAME }}_Setup_$version.exe"

              # List files
              Get-ChildItem "release"

         # Upload artifacts (for debugging)
         - name: Upload Build Artifacts
           uses: actions/upload-artifact@v4
           with:
              name: release-${{ steps.version.outputs.VERSION }}
              path: release/
              retention-days: 7

         # Create GitHub Release
         - name: Create GitHub Release
           uses: softprops/action-gh-release@v1
           if: startsWith(github.ref, 'refs/tags/')
           with:
              name: v${{ steps.version.outputs.VERSION }}
              draft: true # Creates as draft - you can review before publishing
              generate_release_notes: true
              files: |
                 release/${{ env.PROJECT_NAME }}_Setup_${{ steps.version.outputs.VERSION }}.exe
           env:
              GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
